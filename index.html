<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER FLIX PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --red: #e50914; --dark: #141414; --gray: #2f2f2f; }
        body { background: var(--dark); color: white; font-family: 'Arial', sans-serif; margin: 0; }
        .hidden { display: none !important; }
        
        /* TELA DE LOGIN ESTILO NETFLIX */
        #login-screen {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://assets.nflxext.com/ffe/siteui/vlv3/f841d4c7-10e1-40af-bca1-07e3f8eb14af/8a0499e1-1b91-4566-9b55-d14309c68c2d/BR-pt-20220502-popsignuptwoweeks-perspective_alpha_website_medium.jpg');
            background-size: cover; height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .login-box { background: rgba(0,0,0,0.85); padding: 40px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: none; color: white; border-radius: 4px; box-sizing: border-box; }
        .btn-red { background: var(--red); color: white; border: none; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        
        /* HEADER E CATALOGO */
        header { background: #000; padding: 15px 4%; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
        .logo { color: var(--red); font-size: 24px; font-weight: bold; }
        .row { padding: 20px 4%; }
        .movie-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; }
        .card { min-width: 160px; height: 90px; background: #222; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        .card:hover { transform: scale(1.05); }
        .card img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        
        /* PAINEL ADMINISTRATIVO */
        #admin-view { padding: 20px; background: #111; min-height: 100vh; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
        th { color: var(--red); }
        .status-ok { color: #2ecc71; }
        .status-exp { color: #e74c3c; }

        /* PLAYER DE V√çDEO */
        #player-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; }
        video { width: 100%; height: 100%; }
        .close-p { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 2100; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1 style="color:var(--red); margin-bottom:20px;">MASTER FLIX</h1>
        <input type="email" id="email" placeholder="E-mail">
        <input type="password" id="pass" placeholder="Senha">
        <button class="btn-red" onclick="handleLogin()">ENTRAR</button>
        <button class="btn-red" style="background:#555" onclick="handleSignup()">TESTE GR√ÅTIS (7 DIAS)</button>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <div class="logo">MASTER FLIX</div>
        <div>
            <button id="btn-master" class="hidden" onclick="toggleAdmin()" style="background:var(--red); color:white; border:none; padding:8px 12px; cursor:pointer; margin-right:10px;">PAINEL MASTER</button>
            <button onclick="logout()" style="background:none; border:1px solid white; color:white; padding:8px 12px; cursor:pointer;">SAIR</button>
        </div>
    </header>

    <div id="catalog-view">
        <div class="row"><h3>Filmes</h3><div class="movie-list" id="list-movies"></div></div>
        <div class="row"><h3>S√©ries</h3><div class="movie-list" id="list-series"></div></div>
    </div>

    <div id="admin-view" class="hidden">
        <button onclick="toggleAdmin()" style="color:white; background:none; border:1px solid white; padding:10px; cursor:pointer;">‚Üê Voltar ao Cat√°logo</button>
        
        <div style="background:#222; padding:15px; border-radius:8px; margin-top:20px;">
            <h3>Adicionar Nova M√≠dia (TMDB)</h3>
            <input type="text" id="adm-id" placeholder="ID TMDB (Ex: 550)">
            <input type="text" id="adm-url" placeholder="Link do V√≠deo (Drive/Mediafire/Direct)">
            <select id="adm-type" style="width:100%; padding:10px; margin:10px 0; background:#333; color:white; border:none;">
                <option value="movie">Filme</option>
                <option value="tv">S√©rie</option>
            </select>
            <button class="btn-red" onclick="addMedia()">SALVAR NO CAT√ÅLOGO</button>
        </div>

        <div style="background:#222; padding:15px; border-radius:8px; margin-top:20px;">
            <h3>Gest√£o de Usu√°rios e Acessos</h3>
            <table>
                <thead>
                    <tr><th>E-mail</th><th>Expira√ß√£o</th><th>√öltimo Visto</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="user-table"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="player-modal">
    <span class="close-p" onclick="closePlayer()">√ó Fechar</span>
    <video id="main-video" controls onerror="handleVideoError()"></video>
</div>

<script>
    // --- CONFIGURA√á√ïES DO SISTEMA ---
    const TMDB_KEY = "2eaf2fd731f81a77741ecb625b588a40";
    const firebaseConfig = {
        apiKey: "AIzaSyCzxrJMumx3lbjsOXv9JHdXrn29jUg3x_0",
        authDomain: "outflix-9e57d.firebaseapp.com",
        projectId: "outflix-9e57d",
        storageBucket: "outflix-9e57d.firebasestorage.app",
        messagingSenderId: "331164255102",
        appId: "1:331164255102:web:2d2723233cbd58713f692f",
        databaseURL: "https://outflix-9e57d-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Inicializa√ß√£o
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Fun√ß√µes de Autentica√ß√£o
    async function handleLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        try { await auth.signInWithEmailAndPassword(e, p); } catch(err) { alert("Erro de Login: " + err.message); }
    }

    async function handleSignup() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        try {
            const res = await auth.createUserWithEmailAndPassword(e, p);
            const exp = new Date(); exp.setDate(exp.getDate() + 7); // Define 7 dias de teste
            await db.ref('users/' + res.user.uid).set({
                email: e, 
                role: 'user', 
                valido_ate: exp.toISOString(), 
                last_watched: 'Nenhum'
            });
            alert("Conta criada com sucesso! Voc√™ tem 7 dias de teste gr√°tis.");
        } catch(err) { alert("Erro no Cadastro: " + err.message); }
    }

    // Monitor de Sess√£o e Bloqueio de Expira√ß√£o
    auth.onAuthStateChanged(user => {
        if(user) {
            db.ref('users/' + user.uid).on('value', snap => {
                const u = snap.val();
                if(!u) return;

                const hoje = new Date();
                const validade = new Date(u.valido_ate);

                if(hoje > validade && u.role !== 'admin') {
                    // Bloqueio se expirar
                    document.body.innerHTML = `
                        <div style="text-align:center;padding:50px; background:#141414; height:100vh;">
                            <h1 style="color:#e50914;">Acesso Expirado! üîí</h1>
                            <p style="color:white;">O seu per√≠odo de teste ou assinatura terminou.</p>
                            <br>
                            <a href="https://wa.me/5588921484693?text=Ol√° Master, meu acesso expirou e quero renovar!" 
                               style="background:#25d366;color:white;padding:15px 30px;text-decoration:none;border-radius:5px;font-weight:bold;">
                               FALAR COM O MASTER (WHATSAPP)
                            </a>
                        </div>`;
                } else {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    if(u.role === 'admin') document.getElementById('btn-master').classList.remove('hidden');
                    loadCatalog();
                    loadUsers();
                }
            });
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    // Gest√£o do Cat√°logo (TMDB)
    async function addMedia() {
        const id = document.getElementById('adm-id').value;
        const type = document.getElementById('adm-type').value;
        const url = document.getElementById('adm-url').value;
        try {
            const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_KEY}&language=pt-BR`);
            const d = await res.json();
            await db.ref('catalog').push({
                title: d.title || d.name,
                img: `https://image.tmdb.org/t/p/w500${d.backdrop_path}`,
                video: url, 
                type: type
            });
            alert("M√≠dia adicionada com sucesso!");
        } catch(e) { alert("Erro ao buscar m√≠dia no TMDB!"); }
    }

    function loadCatalog() {
        db.ref('catalog').on('value', snap => {
            const mList = document.getElementById('list-movies');
            const sList = document.getElementById('list-series');
            mList.innerHTML = ""; sList.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const html = `
                    <div class="card" onclick="play('${m.video}','${m.title}')">
                        <img src="${m.img}">
                        <p style="font-size:10px;text-align:center;padding:5px;">${m.title}</p>
                    </div>`;
                if(m.type === 'movie') mList.innerHTML += html; else sList.innerHTML += html;
            });
        });
    }

    // Painel Master - Gest√£o de Usu√°rios
    function loadUsers() {
        db.ref('users').on('value', snap => {
            const table = document.getElementById('user-table');
            table.innerHTML = "";
            snap.forEach(c => {
                const u = c.val();
                const exp = new Date(u.valido_ate);
                const status = exp > new Date() ? 'status-ok' : 'status-exp';
                table.innerHTML += `
                    <tr>
                        <td>${u.email}</td>
                        <td class="${status}">${exp.toLocaleDateString()}</td>
                        <td>${u.last_watched}</td>
                        <td><button onclick="renovar('${c.key}')" style="cursor:pointer; padding:5px;">+30 Dias</button></td>
                    </tr>`;
            });
        });
    }

    function renovar(uid) {
        const d = new Date(); d.setDate(d.getDate() + 30);
        db.ref('users/' + uid).update({ valido_ate: d.toISOString() });
        alert("Acesso renovado por 30 dias!");
    }

    // Player de V√≠deo
    function play(url, title) {
        const v = document.getElementById('main-video');
        v.src = url;
        document.getElementById('player-modal').style.display = 'block';
        db.ref('users/' + auth.currentUser.uid).update({ last_watched: title });
        v.play();
    }

    function closePlayer() { 
        document.getElementById('main-video').pause(); 
        document.getElementById('player-modal').style.display='none'; 
    }

    function handleVideoError() { 
        alert("Aviso: O link deste v√≠deo parece estar indispon√≠vel no momento."); 
        closePlayer(); 
    }

    function toggleAdmin() { 
        document.getElementById('catalog-view').classList.toggle('hidden'); 
        document.getElementById('admin-view').classList.toggle('hidden'); 
    }

    function logout() { auth.signOut(); }
</script>
</body>
</html>
